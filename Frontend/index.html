<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BusTracker Pro - Smart Bus Tracking System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* (Your CSS unchanged — omitted here for brevity in explanation; paste the full CSS from your file) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%);
            color: #2d5016;
            line-height: 1.6;
            overflow-x: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(45, 80, 22, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .logo i { color: #90ee90; animation: bounce 2s infinite; }
        @keyframes bounce { 0%,20%,50%,80%,100%{transform:translateY(0);}40%{transform:translateY(-5px);}60%{transform:translateY(-3px);} }
        .nav-buttons { display:flex; gap:1rem; }
        .btn { padding:0.7rem 1.5rem; border:none; border-radius:25px; cursor:pointer; font-weight:600; transition: all .3s ease; display:inline-flex; align-items:center; gap:.5rem; position:relative; overflow:hidden; }
        .btn::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition:left .5s; }
        .btn:hover::before { left:100%; }
        .btn-primary { background: linear-gradient(135deg, #4a7c2a 0%, #6ba83a 100%); color:white; }
        .btn-secondary { background: rgba(255,255,255,0.2); color:white; border:1px solid rgba(255,255,255,0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }

        /* Front Page Styles */
        .front-page { display:block; }
        .hero-section { text-align:center; padding:4rem 2rem; background: linear-gradient(135deg, rgba(74,124,42,0.1) 0%, rgba(144,238,144,0.1) 100%); }
        .hero-title { font-size:3rem; font-weight:800; color:#2d5016; margin-bottom:1rem; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
        .hero-subtitle { font-size:1.2rem; color:#4a7c2a; margin-bottom:3rem; opacity:0.9; }
        .search-container { max-width:800px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:25px; padding:3rem; box-shadow:0 20px 60px rgba(45,80,22,0.15); backdrop-filter: blur(10px); }
        .search-tabs { display:flex; margin-bottom:2rem; border-radius:15px; overflow:hidden; background:#f0f8f0; }
        .search-tab { flex:1; padding:1rem 1.5rem; background:transparent; border:none; cursor:pointer; font-weight:600; color:#4a7c2a; transition: all .3s ease; }
        .search-tab.active { background:linear-gradient(135deg,#4a7c2a 0%,#6ba83a 100%); color:white; transform: scale(1.02); }
        .search-form { display:none; }
        .search-form.active { display:block; animation: slideIn .3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .search-row { display:flex; gap:1rem; margin-bottom:1.5rem; }
        .search-input { flex:1; }
        .search-input label { display:block; margin-bottom:.5rem; font-weight:600; color:#2d5016; }
        .search-input input, .search-input select { width:100%; padding:1rem; border:2px solid #e0f0e0; border-radius:12px; font-size:1rem; transition:all .3s ease; background:white; }
        .search-input input:focus, .search-input select:focus { outline:none; border-color:#4a7c2a; box-shadow:0 0 0 3px rgba(74,124,42,0.1); transform: translateY(-2px); }
        .search-btn { width:100%; background:linear-gradient(135deg,#2d5016 0%, #4a7c2a 100%); color:white; padding:1.2rem; border:none; border-radius:15px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition: all .3s ease; margin-top:1rem; }
        .search-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(45,80,22,0.3); }

        /* Results Page Styles */
        .results-page, .bus-detail-page { display:none; }
        .page-header { background: rgba(255,255,255,0.95); padding:2rem; margin:2rem; border-radius:20px; box-shadow:0 10px 40px rgba(45,80,22,0.1); backdrop-filter: blur(10px); }
        .page-title { font-size:2rem; font-weight:bold; color:#2d5016; margin-bottom:.5rem; }
        .page-subtitle { color:#4a7c2a; font-size:1.1rem; }
        .back-btn { background: rgba(74,124,42,0.1); color:#4a7c2a; border:2px solid #4a7c2a; margin-bottom:1rem; }
        .results-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:2rem; padding:2rem; }
        .bus-card { background:linear-gradient(135deg,#ffffff 0%, #f0f8f0 100%); border:2px solid #e0f0e0; border-radius:20px; padding:2rem; cursor:pointer; transition: all .3s ease; position:relative; overflow:hidden; }
        .bus-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background: linear-gradient(90deg,#4a7c2a,#6ba83a,#4a7c2a); background-size:200% 100%; animation: shimmer 2s ease-in-out infinite; }
        @keyframes shimmer { 0% { background-position:-200% 0; } 100%{ background-position:200% 0; } }
        .bus-card:hover { transform: translateY(-5px) scale(1.02); box-shadow:0 15px 40px rgba(74,124,42,0.2); border-color:#4a7c2a; }
        .bus-number { font-size:1.5rem; font-weight:bold; color:#2d5016; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
        .bus-route { color:#4a7c2a; margin-bottom:1rem; font-weight:600; }
        .bus-status { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .status-badge { padding:.3rem .8rem; border-radius:20px; font-size:.8rem; font-weight:bold; }
        .status-active { background:#d4edda; color:#155724; }
        .status-inactive { background:#f8d7da; color:#721c24; }
        .eta { font-weight:bold; color:#2d5016; }

        /* Bus Detail Page Styles */
        .bus-detail-container { display:grid; grid-template-columns: 1fr 2fr; gap:2rem; padding:2rem; min-height:calc(100vh - 200px); }
        .bus-info-panel { background:rgba(255,255,255,0.95); border-radius:20px; padding:2rem; box-shadow:0 10px 40px rgba(45,80,22,0.1); backdrop-filter:blur(10px); height:fit-content; position:sticky; top:120px; }
        .bus-info-header { text-align:center; padding-bottom:2rem; border-bottom:2px solid #e0f0e0; margin-bottom:2rem; }
        .bus-name { font-size:2rem; font-weight:bold; color:#2d5016; margin-bottom:.5rem; }
        .route-info { font-size:1.1rem; color:#4a7c2a; font-weight:600; }
        .info-section { margin-bottom:2rem; }
        .info-title { font-size:1.2rem; font-weight:bold; color:#2d5016; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
        .info-item { display:flex; justify-content:space-between; align-items:center; padding:.8rem; background:#f0f8f0; border-radius:10px; margin-bottom:.5rem; }
        .info-label { color:#4a7c2a; font-weight:600; }
        .info-value { color:#2d5016; font-weight:bold; }
        .map-container { background:white; border-radius:20px; box-shadow:0 10px 40px rgba(45,80,22,0.1); overflow:hidden; position:relative; }
        .map-header { background:linear-gradient(135deg,#4a7c2a 0%,#6ba83a 100%); color:white; padding:1.5rem; display:flex; justify-content:space-between; align-items:center; }
        .map-title { font-size:1.4rem; font-weight:bold; }
        .map-controls { display:flex; gap:.5rem; }

        .map-btn { padding:.5rem 1rem; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); border-radius:8px; color:white; cursor:pointer; transition:all .3s ease; }
        .map-btn:hover { background:rgba(255,255,255,0.3); transform: translateY(-2px); }

        #map { height:600px; width:100%; }

        .loading { display:flex; justify-content:center; align-items:center; height:300px; flex-direction:column; gap:1rem; }
        .spinner { width:40px; height:40px; border:4px solid #e0f0e0; border-top:4px solid #4a7c2a; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

        .alert { padding:1rem; border-radius:12px; margin-bottom:1rem; position:fixed; top:100px; right:20px; z-index:3000; max-width:300px; animation: slideInRight .3s ease; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
        .alert-error { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
        .pulse { animation:pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1;}50%{opacity:0.5;}100%{opacity:1;} }

        @media (max-width:768px) {
            .hero-title { font-size:2rem; }
            .search-container { margin:1rem; padding:2rem; }
            .search-row { flex-direction:column; gap:.5rem; }
            .bus-detail-container { grid-template-columns:1fr; padding:1rem; }
            .results-grid { grid-template-columns:1fr; padding:1rem; }
            #map { height:400px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="showFrontPage()">
                <i class="fas fa-bus"></i>
                BusTracker Pro
            </div>
            <nav class="nav-buttons">
                <button class="btn btn-secondary" onclick="showAddBusModal()">
                    <i class="fas fa-plus"></i> Add Bus
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </nav>
        </div>
    </header>

    <!-- Front Page -->
    <div class="front-page" id="frontPage">
        <section class="hero-section">
            <h1 class="hero-title">Track Your Bus in Real-Time</h1>
            <p class="hero-subtitle">Find buses by route or track specific buses with live location updates</p>

            <div class="search-container">
                <div class="search-tabs">
                    <button class="search-tab active" onclick="switchTab('route')">
                        <i class="fas fa-route"></i> Search by Route
                    </button>
                    <button class="search-tab" onclick="switchTab('bus')">
                        <i class="fas fa-bus"></i> Search by Bus ID
                    </button>
                </div>

                <!-- Route Search Form -->
                <form class="search-form active" id="routeForm">
                    <div class="search-row">
                        <div class="search-input">
                            <label>From</label>
                            <input type="text" id="fromLocation" placeholder="Enter starting location..." required>
                        </div>
                        <div class="search-input">
                            <label>To</label>
                            <input type="text" id="toLocation" placeholder="Enter destination..." required>
                        </div>
                    </div>
                    <div class="search-row">
                        <div class="search-input">
                            <label>Departure Time (Optional)</label>
                            <input type="time" id="departureTime">
                        </div>
                        <div class="search-input">
                            <label>Date (Optional)</label>
                            <input type="date" id="searchDate">
                        </div>
                    </div>
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i> Find Buses
                    </button>
                </form>

                <!-- Bus ID Search Form -->
                <form class="search-form" id="busForm">
                    <div class="search-row">
                        <div class="search-input">
                            <label>Bus ID / Device ID</label>
                            <input type="text" id="busIdSearch" placeholder="Enter bus or device ID..." required>
                        </div>
                    </div>
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i> Track Bus
                    </button>
                </form>
            </div>
        </section>
    </div>

    <!-- Results Page -->
    <div class="results-page" id="resultsPage">
        <div class="page-header">
            <button class="btn back-btn" onclick="showFrontPage()">
                <i class="fas fa-arrow-left"></i> Back to Search
            </button>
            <h2 class="page-title" id="resultsTitle">Available Buses</h2>
            <p class="page-subtitle" id="resultsSubtitle">Found buses for your route</p>
        </div>

        <div class="results-grid" id="resultsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <span>Searching for buses...</span>
            </div>
        </div>
    </div>

    <!-- Bus Detail Page -->
    <div class="bus-detail-page" id="busDetailPage">
        <div class="page-header">
            <button class="btn back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <h2 class="page-title" id="detailTitle">Bus Details</h2>
            <p class="page-subtitle" id="detailSubtitle">Real-time tracking and information</p>
        </div>

        <div class="bus-detail-container">
            <div class="bus-info-panel">
                <div class="bus-info-header">
                    <h3 class="bus-name" id="busName">Bus #101</h3>
                    <p class="route-info" id="routeInfo">Kolkata - Howrah</p>
                </div>

                <div class="info-section">
                    <h4 class="info-title">
                        <i class="fas fa-clock"></i> Journey Information
                    </h4>
                    <div class="info-item">
                        <span class="info-label">Expected Arrival:</span>
                        <span class="info-value" id="expectedTime">15 mins</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Journey Started:</span>
                        <span class="info-value" id="startTime">10:30 AM</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Distance Covered:</span>
                        <span class="info-value" id="distanceCovered">12.5 km</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Average Speed:</span>
                        <span class="info-value" id="avgSpeed">35 km/h</span>
                    </div>
                </div>

                <div class="info-section">
                    <h4 class="info-title">
                        <i class="fas fa-user"></i> Driver Information
                    </h4>
                    <div class="info-item">
                        <span class="info-label">Driver Name:</span>
                        <span class="info-value" id="driverName">Ramesh Kumar</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">License No:</span>
                        <span class="info-value" id="licenseNo">WB-2345678</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Contact:</span>
                        <span class="info-value" id="driverContact">+91-9876543210</span>
                    </div>
                </div>

                <div class="info-section">
                    <h4 class="info-title">
                        <i class="fas fa-info-circle"></i> Bus Status
                    </h4>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value status-active pulse" id="busStatus">Active</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Updated:</span>
                        <span class="info-value" id="lastUpdated">Just now</span>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div class="map-header">
                    <h3 class="map-title">Live Bus Location</h3>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centerOnBus()">
                            <i class="fas fa-crosshairs"></i> Center
                        </button>
                        <button class="map-btn" onclick="toggleRoute()">
                            <i class="fas fa-route"></i> Route
                        </button>
                        <button class="map-btn" onclick="fitRoute()">
                            <i class="fas fa-expand"></i> Fit All
                        </button>
                        <button class="map-btn" onclick="locateMe()">
                            <i class="fas fa-map-marker-alt"></i> My Location
                        </button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Add Bus Modal -->
    <div id="addBusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 1rem; color: #2d5016;">Add New Bus</h3>
            <div class="search-input">
                <label>Device ID</label>
                <input type="text" id="newBusId" placeholder="Enter unique device ID...">
            </div>
            <div class="search-input">
                <label>Driver Name</label>
                <input type="text" id="newDriverName" placeholder="Enter driver name...">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="addNewBus()" style="flex: 1;">
                    <i class="fas fa-plus"></i> Add Bus
                </button>
                <button class="btn btn-secondary" onclick="hideAddBusModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentBus = null;
        let busMarker = null;
        let routeLine = null;
        let startMarker = null;
        let buses = [];
        let currentView = 'front';
        let searchData = {};
        let previousPage = 'front';
        const API_BASE = 'https://gps-tracker-4ffh.onrender.com/api/v1'; // Update with your backend URL
        const POLL_INTERVAL = 8000; // ms
        let poller = null;

        // Sample data for demonstration (replace with actual API calls)
        const sampleBuses = [
            {
                deviceID: "BUS001",
                busNumber: "101",
                route: "Kolkata - Howrah",
                from: "Kolkata",
                to: "Howrah",
                driverName: "Ramesh Kumar",
                licenseNo: "WB-2345678",
                driverContact: "+91-9876543210",
                expectedTime: "15 mins",
                startTime: "10:30 AM",
                status: "active",
                location: {
                    type: "Point",
                    coordinates: [88.3639, 22.5726]
                },
                route: [
                    { coordinates: [88.3500, 22.5600] },
                    { coordinates: [88.3550, 22.5650] },
                    { coordinates: [88.3600, 22.5700] }
                ],
                lastUpdated: new Date()
            },
            {
                deviceID: "BUS002",
                busNumber: "102",
                route: "Kolkata - Salt Lake",
                from: "Kolkata",
                to: "Salt Lake",
                driverName: "Suresh Pal",
                licenseNo: "WB-2345679",
                driverContact: "+91-9876543211",
                expectedTime: "8 mins",
                startTime: "11:00 AM",
                status: "active",
                location: {
                    type: "Point",
                    coordinates: [88.3739, 22.5826]
                },
                route: [
                    { coordinates: [88.3639, 22.5726] },
                    { coordinates: [88.3689, 22.5776] }
                ],
                lastUpdated: new Date()
            }
        ];

        // Initialize map
        function initMap() {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([22.5726, 88.3639], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // adjust if container size changed
            setTimeout(() => { if (map) map.invalidateSize(); }, 200);
        }

        // Custom icons
        const busIcon = L.divIcon({
            html: '<i class="fas fa-bus" style="color: #4a7c2a; font-size: 28px; text-shadow: 0 0 5px white;"></i>',
            iconSize: [35, 35],
            className: 'bus-marker'
        });

        const startIcon = L.divIcon({
            html: '<i class="fas fa-play-circle" style="color: #2d5016; font-size: 24px; text-shadow: 0 0 3px white;"></i>',
            iconSize: [30, 30],
            className: 'start-marker'
        });

        const endIcon = L.divIcon({
            html: '<i class="fas fa-stop-circle" style="color: #dc3545; font-size: 24px; text-shadow: 0 0 3px white;"></i>',
            iconSize: [30, 30],
            className: 'end-marker'
        });

        // Tab switching
        function switchTab(tabType) {
            const tabs = document.querySelectorAll('.search-tab');
            const forms = document.querySelectorAll('.search-form');

            tabs.forEach(tab => tab.classList.remove('active'));
            forms.forEach(form => form.classList.remove('active'));

            if (tabType === 'route') {
                tabs[0].classList.add('active');
                document.getElementById('routeForm').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('busForm').classList.add('active');
            }
        }

        // Page navigation
        function showFrontPage() {
            stopPolling();
            document.getElementById('frontPage').style.display = 'block';
            document.getElementById('resultsPage').style.display = 'none';
            document.getElementById('busDetailPage').style.display = 'none';
            currentView = 'front';
        }

        function showResultsPage() {
            stopPolling();
            document.getElementById('frontPage').style.display = 'none';
            document.getElementById('resultsPage').style.display = 'block';
            document.getElementById('busDetailPage').style.display = 'none';
            currentView = 'results';
            previousPage = 'front';
            // Optionally fetch live list of buses here
            fetchBusesForResults();
        }

        function showBusDetailPage() {
            document.getElementById('frontPage').style.display = 'none';
            document.getElementById('resultsPage').style.display = 'none';
            document.getElementById('busDetailPage').style.display = 'block';
            currentView = 'detail';

            setTimeout(() => {
                initMap();
                if (currentBus) {
                    displayBusOnMap(currentBus);
                }
                startPolling();
            }, 100);
        }

        function goBack() {
            if (previousPage === 'results') {
                showResultsPage();
            } else {
                showFrontPage();
            }
        }

        // Search handling
        document.getElementById('routeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleRouteSearch();
        });

        document.getElementById('busForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleBusSearch();
        });

        async function handleRouteSearch() {
            const from = document.getElementById('fromLocation').value.trim();
            const to = document.getElementById('toLocation').value.trim();
            const time = document.getElementById('departureTime').value;
            const date = document.getElementById('searchDate').value;

            if (!from || !to) {
                showAlert('Please enter both from and to locations', 'error');
                return;
            }

            searchData = { type: 'route', from, to, time, date };

            // Update results page
            document.getElementById('resultsTitle').textContent = 'Available Buses';
            document.getElementById('resultsSubtitle').textContent = `From ${from} to ${to}`;

            showResultsPage();
            await searchBusesByRoute(from, to);
        }

        async function handleBusSearch() {
            const busId = document.getElementById('busIdSearch').value.trim();

            if (!busId) {
                showAlert('Please enter a bus ID', 'error');
                return;
            }

            searchData = { type: 'bus', busId };

            try {
                // Try to get specific bus data from API
                const response = await fetch(`${API_BASE}/location/get/${busId}`);
                const data = await response.json();

                if (data && data.success && data.latestLocations) {
                    // Normalize result to expected shape
                    const normalized = unifyBusFromApi(data, busId);
                    currentBus = normalized;
                    previousPage = 'front';
                    showBusDetailPage();
                    updateBusInfo(currentBus);
                } else {
                    // Fallback to sample data for demo
                    const bus = sampleBuses.find(b => b.deviceID === busId || b.busNumber === busId);
                    if (bus) {
                        currentBus = bus;
                        previousPage = 'front';
                        showBusDetailPage();
                        updateBusInfo(currentBus);
                    } else {
                        showAlert('Bus not found', 'error');
                    }
                }
            } catch (error) {
                console.error('Error fetching bus:', error);
                // Fallback to sample data
                const bus = sampleBuses.find(b => b.deviceID === busId || b.busNumber === busId);
                if (bus) {
                    currentBus = bus;
                    previousPage = 'front';
                    showBusDetailPage();
                    updateBusInfo(currentBus);
                } else {
                    showAlert('Error fetching bus data', 'error');
                }
            }
        }

        // Convert various API shapes to our internal shape (best-effort)
        function unifyBusFromApi(apiData, busIdFallback) {
            const out = {
                deviceID: busIdFallback || (apiData.deviceID || apiData.deviceid),
                busNumber: apiData.busNumber || apiData.busNumber || busIdFallback,
                route: apiData.route || 'Route data',
                from: apiData.from || '',
                to: apiData.to || '',
                driverName: apiData.driverName || apiData.driver || 'Unknown',
                licenseNo: apiData.licenseNo || apiData.license || 'N/A',
                driverContact: apiData.driverContact || apiData.contact || 'N/A',
                expectedTime: apiData.expectedTime || '-- mins',
                startTime: apiData.startTime || new Date().toLocaleTimeString(),
                status: apiData.status || 'active',
                location: null,
                route: apiData.routePoints || apiData.route || []
            };

            // Try to extract a latest location from common shapes
            try {
                let loc = apiData.latestLocations;
                if (!loc && apiData.location) loc = apiData.location;
                if (!loc && apiData.data) loc = apiData.data;
                if (Array.isArray(loc) && loc.length) loc = loc[loc.length - 1];

                if (loc) {
                    if (loc.coordinates && Array.isArray(loc.coordinates)) {
                        out.location = { type: 'Point', coordinates: [loc.coordinates[0], loc.coordinates[1]] };
                    } else if (loc.longitude !== undefined && loc.latitude !== undefined) {
                        out.location = { type: 'Point', coordinates: [parseFloat(loc.longitude), parseFloat(loc.latitude)] };
                    } else if (loc.lat !== undefined && loc.lon !== undefined) {
                        out.location = { type: 'Point', coordinates: [parseFloat(loc.lon), parseFloat(loc.lat)] };
                    }
                }
            } catch (e) {
                // ignore and fallback
            }

            if (!out.location && apiData.latitude && apiData.longitude) {
                out.location = { type: 'Point', coordinates: [parseFloat(apiData.longitude), parseFloat(apiData.latitude)] };
            }

            out.lastUpdated = apiData.lastUpdated ? new Date(apiData.lastUpdated) : new Date();
            return out;
        }

        async function searchBusesByRoute(from, to) {
            try {
                // If you have API endpoint to search for buses by route, call it here.
                // For now use sample data filter as demo:
                const filteredBuses = sampleBuses.filter(bus =>
                    bus.from.toLowerCase().includes(from.toLowerCase()) &&
                    bus.to.toLowerCase().includes(to.toLowerCase())
                );

                displaySearchResults(filteredBuses);
            } catch (error) {
                console.error('Error searching buses:', error);
                displaySearchResults([]);
            }
        }

        function displaySearchResults(busesArr) {
            const resultsGrid = document.getElementById('resultsGrid');

            if (!busesArr || busesArr.length === 0) {
                resultsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: #666;">
                        <i class="fas fa-bus" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <h3>No buses found</h3>
                        <p>Try adjusting your search criteria</p>
                        <button class="btn btn-primary" onclick="showFrontPage()" style="margin-top: 2rem;">
                            <i class="fas fa-search"></i> Search Again
                        </button>
                    </div>
                `;
                return;
            }

            resultsGrid.innerHTML = busesArr.map(bus => `
                <div class="bus-card" onclick="selectBusFromResults('${bus.deviceID}')">
                    <div class="bus-number">
                        <i class="fas fa-bus"></i>
                        Bus #${bus.busNumber}
                    </div>
                    <div class="bus-route">${bus.route}</div>
                    <div class="bus-status">
                        <span class="status-badge ${bus.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${bus.status === 'active' ? 'Active' : 'Inactive'}
                        </span>
                        <span class="eta">ETA: ${bus.expectedTime}</span>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0f0e0; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-user"></i> Driver: ${bus.driverName}
                    </div>
                </div>
            `).join('');
        }

        function selectBusFromResults(deviceID) {
            const bus = sampleBuses.find(b => b.deviceID === deviceID);
            if (bus) {
                currentBus = bus;
                previousPage = 'results';
                showBusDetailPage();
                updateBusInfo(currentBus);
            } else {
                // Try to fetch from API
                (async () => {
                    try {
                        const res = await fetch(`${API_BASE}/location/get/${deviceID}`);
                        const json = await res.json();
                        if (json && json.success) {
                            currentBus = unifyBusFromApi(json, deviceID);
                            previousPage = 'results';
                            showBusDetailPage();
                            updateBusInfo(currentBus);
                        } else {
                            showAlert('Bus data not available', 'error');
                        }
                    } catch (err) {
                        showAlert('Error fetching bus', 'error');
                    }
                })();
            }
        }

        function updateBusInfo(bus) {
            document.getElementById('busName').textContent = `Bus #${bus.busNumber || bus.deviceID}`;
            document.getElementById('routeInfo').textContent = bus.route || `${bus.from} - ${bus.to}`;
            document.getElementById('expectedTime').textContent = bus.expectedTime || '-- mins';
            document.getElementById('startTime').textContent = bus.startTime || 'Unknown';
            document.getElementById('driverName').textContent = bus.driverName || 'Unknown';
            document.getElementById('licenseNo').textContent = bus.licenseNo || 'N/A';
            document.getElementById('driverContact').textContent = bus.driverContact || 'N/A';
            document.getElementById('busStatus').textContent = bus.status === 'active' ? 'Active' : 'Inactive';
            document.getElementById('lastUpdated').textContent = formatTime(bus.lastUpdated);

            // Compute distance including current position
            let routeForDistance = Array.isArray(bus.route) ? bus.route.slice() : [];
            if (bus.location && bus.location.coordinates) {
                routeForDistance.push({ coordinates: bus.location.coordinates });
            }

            if (routeForDistance && routeForDistance.length > 1) {
                const distance = calculateTotalDistance(routeForDistance);
                document.getElementById('distanceCovered').textContent = `${distance.toFixed(1)} km`;

                // Parse start time (accept formats like "10:30 AM" or ISO)
                const startDate = parseStartTimeToDate(bus.startTime) || new Date(Date.now() - 30 * 60 * 1000); // fallback: 30 mins ago
                let timeDiffHours = (new Date() - startDate) / (1000 * 60 * 60);
                if (!isFinite(timeDiffHours) || timeDiffHours <= 0.01) timeDiffHours = 0.01;

                const avgSpeed = distance / timeDiffHours;
                document.getElementById('avgSpeed').textContent = `${avgSpeed.toFixed(1)} km/h`;
            } else {
                document.getElementById('distanceCovered').textContent = '0.0 km';
                document.getElementById('avgSpeed').textContent = '-- km/h';
            }

            document.getElementById('detailTitle').textContent = `Bus #${bus.busNumber || bus.deviceID}`;
            document.getElementById('detailSubtitle').textContent = `${bus.route || ''} - Real-time tracking`;
        }

        function displayBusOnMap(bus) {
            if (!map || !bus || !bus.location || !bus.location.coordinates) return;

            const [lng, lat] = bus.location.coordinates;

            // Clear route / start markers (we keep the busMarker to animate)
            if (routeLine) {
                try { map.removeLayer(routeLine); } catch (e) {}
                routeLine = null;
            }
            if (startMarker) {
                try { map.removeLayer(startMarker); } catch (e) {}
                startMarker = null;
            }

            // Add or animate bus marker
            if (!busMarker) {
                busMarker = L.marker([lat, lng], { icon: busIcon }).addTo(map);
                busMarker.bindPopup(getBusPopupHtml(bus));
            } else {
                animateMarkerTo(busMarker, [lat, lng], 700);
                // Update popup content if open or closed
                busMarker.setPopupContent(getBusPopupHtml(bus));
            }

            // Add route line if route data exists
            if (bus.route && bus.route.length > 0) {
                // convert route points to [lat, lng]
                const routeCoords = bus.route.map(point => [point.coordinates[1], point.coordinates[0]]);
                // add current location as last point
                routeCoords.push([lat, lng]);

                routeLine = L.polyline(routeCoords, {
                    color: '#4a7c2a',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                }).addTo(map);

                // Add start marker (first point)
                const startCoords = bus.route[0].coordinates;
                startMarker = L.marker([startCoords[1], startCoords[0]], { icon: startIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align:center;">
                            <strong>Journey Start</strong><br>
                            <small>Started at: ${bus.startTime || 'Unknown'}</small>
                        </div>
                    `);

                // Fit map
                fitRoute();
            } else {
                // center on bus if no route
                map.setView([lat, lng], 15);
            }
        }

        function getBusPopupHtml(bus) {
            return `
                <div style="text-align: center; min-width: 200px;">
                    <strong>Bus #${bus.busNumber || bus.deviceID}</strong><br>
                    <div style="color: #4a7c2a; font-weight: bold;">${bus.route || ''}</div>
                    <div style="margin: 0.5rem 0;">
                        <i class="fas fa-user"></i> ${bus.driverName || 'Driver'}<br>
                        <i class="fas fa-clock"></i> ETA: ${bus.expectedTime || '--'}
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">
                        Last updated: ${formatTime(bus.lastUpdated)}
                    </div>
                </div>
            `;
        }

        // Map controls
        function centerOnBus() {
            if (busMarker) {
                map.setView(busMarker.getLatLng(), 15);
                busMarker.openPopup();
            } else {
                showAlert('No bus location available', 'error');
            }
        }

        function toggleRoute() {
            if (routeLine) {
                if (map.hasLayer(routeLine)) {
                    map.removeLayer(routeLine);
                    if (startMarker) map.removeLayer(startMarker);
                } else {
                    map.addLayer(routeLine);
                    if (startMarker) map.addLayer(startMarker);
                }
            }
        }

        function fitRoute() {
            if (routeLine) {
                map.fitBounds(routeLine.getBounds(), { padding: [20, 20] });
            } else if (busMarker) {
                map.setView(busMarker.getLatLng(), 15);
            }
        }

        // Animate marker smoothly to new position
        function animateMarkerTo(marker, toLatLng, duration = 700) {
            if (!marker) return;
            const start = marker.getLatLng();
            const end = L.latLng(toLatLng[0], toLatLng[1]);
            const frames = Math.max(10, Math.round(duration / 16));
            let frame = 0;
            const latDiff = (end.lat - start.lat) / frames;
            const lngDiff = (end.lng - start.lng) / frames;

            const anim = setInterval(() => {
                frame++;
                const newLat = start.lat + latDiff * frame;
                const newLng = start.lng + lngDiff * frame;
                marker.setLatLng([newLat, newLng]);
                if (frame >= frames) {
                    clearInterval(anim);
                    marker.setLatLng(end);
                }
            }, 16);
        }

        // Utility functions
        function calculateTotalDistance(route) {
            if (!route || route.length < 2) return 0;

            let distance = 0;
            for (let i = 1; i < route.length; i++) {
                const lat1 = route[i - 1].coordinates[1];
                const lng1 = route[i - 1].coordinates[0];
                const lat2 = route[i].coordinates[1];
                const lng2 = route[i].coordinates[0];

                distance += getDistanceBetweenPoints(lat1, lng1, lat2, lng2);
            }
            return distance;
        }

        function getDistanceBetweenPoints(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function formatTime(date) {
            if (!date) return 'Never';
            const now = new Date();
            const diff = now - new Date(date);

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} hr ago`;

            return new Date(date).toLocaleString();
        }

        function parseStartTimeToDate(startTime) {
            if (!startTime) return null;
            if (startTime instanceof Date) return startTime;
            const asDate = new Date(startTime);
            if (!isNaN(asDate.getTime())) return asDate;

            // Try "HH:MM AM/PM" formats
            const match = ('' + startTime).match(/(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?/);
            if (match) {
                let h = parseInt(match[1], 10);
                const m = parseInt(match[2], 10);
                const ampm = match[3];
                if (ampm) {
                    if (ampm.toLowerCase() === 'pm' && h !== 12) h += 12;
                    if (ampm.toLowerCase() === 'am' && h === 12) h = 0;
                }
                const now = new Date();
                now.setHours(h, m, 0, 0);
                return now;
            }
            return null;
        }

        // Bus management
        async function addNewBus() {
            const deviceID = document.getElementById('newBusId').value.trim();
            const driverName = document.getElementById('newDriverName').value.trim();

            if (!deviceID) {
                showAlert('Please enter a device ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/location/create/newBus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ deviceID })
                });

                const data = await response.json();

                if (data && data.success) {
                    // Add to sample data for demo
                    const newBus = {
                        deviceID,
                        busNumber: deviceID,
                        route: "New Route",
                        from: "Start",
                        to: "End",
                        driverName: driverName || "New Driver",
                        licenseNo: "WB-XXXXXXX",
                        driverContact: "+91-XXXXXXXXXX",
                        expectedTime: "-- mins",
                        startTime: new Date().toLocaleTimeString(),
                        status: "inactive",
                        location: null,
                        route: [],
                        lastUpdated: new Date()
                    };

                    sampleBuses.push(newBus);
                    hideAddBusModal();
                    showAlert(`Bus ${deviceID} added successfully!`, 'success');
                } else {
                    showAlert((data && data.message) ? data.message : 'Failed to add bus', 'error');
                }
            } catch (error) {
                console.error('Error adding bus:', error);
                showAlert('Error adding bus', 'error');
            }
        }

        function showAddBusModal() {
            document.getElementById('addBusModal').style.display = 'flex';
            document.getElementById('newBusId').value = '';
            document.getElementById('newDriverName').value = '';
        }

        function hideAddBusModal() {
            document.getElementById('addBusModal').style.display = 'none';
        }

        function refreshData() {
            if (currentView === 'detail' && currentBus) {
                // Refresh current bus data
                (async () => {
                    const updated = await fetchLatestForBus(currentBus.deviceID);
                    if (updated) {
                        currentBus.location = updated.location;
                        currentBus.lastUpdated = new Date();
                        updateBusInfo(currentBus);
                        displayBusOnMap(currentBus);
                    }
                })();
            } else if (currentView === 'results' && searchData.type === 'route') {
                // Refresh route search
                searchBusesByRoute(searchData.from, searchData.to);
            } else {
                // optionally refresh all buses list
                fetchBusesForResults();
            }

            showAlert('Data refreshed!', 'success');
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Auto-refresh for live tracking
        setInterval(() => {
            if (currentView === 'detail' && currentBus) {
                // optimistic UI update; lastUpdated gets updated when actual data arrives
                document.getElementById('lastUpdated').textContent = 'Just now';
            }
        }, 10000); // Update UI indicator every 10 seconds

        // Polling (start/stop)
        function startPolling() {
            stopPolling(); // reset
            poller = setInterval(async () => {
                if (currentView === 'detail' && currentBus && currentBus.deviceID) {
                    const updated = await fetchLatestForBus(currentBus.deviceID);
                    if (updated && updated.location) {
                        // update local object
                        currentBus.location = updated.location;
                        currentBus.lastUpdated = new Date();
                        // If API provided extra info, merge (best-effort)
                        if (updated.expectedTime) currentBus.expectedTime = updated.expectedTime;
                        updateBusInfo(currentBus);
                        displayBusOnMap(currentBus);
                    } else {
                        // no update — still keep UI alive
                    }
                }
            }, POLL_INTERVAL);
        }

        function stopPolling() {
            if (poller) {
                clearInterval(poller);
                poller = null;
            }
        }

        // Fetch latest location from API (best-effort, flexible parsing)
        async function fetchLatestForBus(deviceID) {
            if (!deviceID) return null;
            try {
                const res = await fetch(`${API_BASE}/location/get/${deviceID}`);
                const json = await res.json();
                if (json && json.success) {
                    // Try many shapes
                    let loc = null;
                    if (json.latestLocations) {
                        loc = Array.isArray(json.latestLocations) ? json.latestLocations[json.latestLocations.length - 1] : json.latestLocations;
                    } else if (json.location) {
                        loc = json.location;
                    } else if (json.data) {
                        loc = Array.isArray(json.data) ? json.data[json.data.length - 1] : json.data;
                    } else {
                        loc = json;
                    }

                    if (loc) {
                        let lng, lat;
                        if (Array.isArray(loc.coordinates)) {
                            // maybe [lng, lat] or [lat, lng] — check typical values (> 80 for longitude in India)
                            if (Math.abs(loc.coordinates[0]) > 90 || Math.abs(loc.coordinates[1]) > 90) {
                                // unlikely lat/lng swapped — just assume [lng, lat]
                                [lng, lat] = [loc.coordinates[0], loc.coordinates[1]];
                            } else {
                                // Heuristic: in India, lat ~ 20-30 and lng ~ 70-90; so if first is 88.x -> it's lng
                                if (Math.abs(loc.coordinates[0]) > Math.abs(loc.coordinates[1])) {
                                    [lng, lat] = [loc.coordinates[0], loc.coordinates[1]];
                                } else {
                                    [lng, lat] = [loc.coordinates[1], loc.coordinates[0]];
                                }
                            }
                        } else if (loc.longitude !== undefined && loc.latitude !== undefined) {
                            lng = parseFloat(loc.longitude);
                            lat = parseFloat(loc.latitude);
                        } else if (loc.lon !== undefined && loc.lat !== undefined) {
                            lng = parseFloat(loc.lon);
                            lat = parseFloat(loc.lat);
                        } else if (loc.lng !== undefined && loc.lat !== undefined) {
                            lng = parseFloat(loc.lng);
                            lat = parseFloat(loc.lat);
                        }

                        if (!isNaN(lat) && !isNaN(lng)) {
                            return {
                                location: { type: 'Point', coordinates: [lng, lat] },
                                expectedTime: json.expectedTime || null
                            };
                        }
                    }
                }
            } catch (err) {
                console.warn('fetchLatestForBus error', err);
            }

            // fallback: try to simulate small movement for demo (if sampleBuses has device)
            const demo = sampleBuses.find(b => b.deviceID === deviceID);
            if (demo && demo.location && demo.location.coordinates) {
                // nudge slightly to simulate movement
                const [lng, lat] = demo.location.coordinates;
                const deltaLng = (Math.random() - 0.5) * 0.0008;
                const deltaLat = (Math.random() - 0.5) * 0.0008;
                demo.location.coordinates = [lng + deltaLng, lat + deltaLat];
                demo.lastUpdated = new Date();
                return { location: demo.location };
            }

            return null;
        }

        // Fetch list of buses for results page (demo/fallback)
        async function fetchBusesForResults() {
            try {
                // Replace with your real API call if you have one:
                // const res = await fetch(`${API_BASE}/buses`);
                // const json = await res.json(); ...
                displaySearchResults(sampleBuses);
            } catch (e) {
                console.warn('fetchBusesForResults failed', e);
                displaySearchResults(sampleBuses);
            }
        }

        // Geolocation helper for "Locate Me"
        function locateMe() {
            if (!navigator.geolocation) {
                showAlert('Geolocation not supported by your browser', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                if (map) {
                    map.setView([lat, lng], 14);
                    // optional: place a temporary marker
                    const tmp = L.circleMarker([lat, lng], { radius: 6, fillColor: '#3388ff', fillOpacity: 0.9, color: '#fff', weight: 1 }).addTo(map);
                    setTimeout(() => { try { map.removeLayer(tmp); } catch (e) {} }, 4000);
                }
                showAlert('Centered on your location', 'success');
            }, (err) => {
                console.warn('geolocation error', err);
                if (err.code === 1) {
                    showAlert('Location permission denied. Please allow location to use this feature.', 'error');
                } else {
                    showAlert('Unable to get your location', 'error');
                }
            }, { enableHighAccuracy: true, timeout: 8000 });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const searchDateEl = document.getElementById('searchDate');
            if (searchDateEl) searchDateEl.value = new Date().toISOString().split('T')[0];

            // Initialize with front page
            showFrontPage();

            // Preload results (demo)
            fetchBusesForResults();

            // If user navigates away, stop polling
            window.addEventListener('beforeunload', () => stopPolling());
        });
    </script>
</body>
</html>
